<!DOCTYPE html>
<html>
    <body>
        <h1>Common Sound Tester</h1>

        <div>
            <textarea id="output" cols="80" rows="33" style="font-size:8px;color:#FFFFFF;background-color:#000000;"></textarea>
            <img id="current-album" width="300" height="300" src=""/>
            <br/>
            <button id="clear">Clear</button>
        </div>
        <hr/>
        <div>
            <h2>Searching</h2>
            <input id="query" />
            <button id="find">find</button>
        </div>
        <hr/>
        <div>
            <h2>Play Track</h2>
            <input id="track" placeholder="track uri" />
            <button id="play">Play</button>
            <button id="pause">Pause</button>
            <button id="enqueue">Enqueue</button>
        </div>

        <hr/>
        <div>
            <h2>Fetch Artwork</h2>
            <input id="album" placeholder="album uri" />
            <button id="fetch">Fetch</button>
            <div id="images" style="margin-top:5px;"></div>
        </div>

        <script>//AUTOBAHN_DEBUG = true;</script>
        <script src="http://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz"></script>
        <script src="common-sound.js">

        </script>

        <script>
            var sound = null;
            var wsuri;
            var current_image_uri = null;

            if (document.location.origin == "file://") {
                wsuri = "ws://127.0.0.1:8080/ws";
            } else {
                wsuri = (document.location.protocol === "http:" ? "ws:" : "wss:") + "//" + document.location.host + "/ws";
            }

            var connection = new autobahn.Connection({
                url: wsuri,
                realm: "player"
            });

            function onEmit(args) {
                var state = args[0];
                var s = state.state;
                s = s.charAt(0).toUpperCase() + s.slice(1);
                try {
                    s = s + " - " + state.track.name;
                    if (state.track.album.cover_uri != current_image_uri) {
                        current_image_uri = state.track.album.cover_uri
                        sound.cover_image(current_image_uri).then(function(result) {
                            var image = document.getElementById("current-album");
                            image.src = result.data;
                        });
                    }
                } catch(e){}
                try {
                    s = s + " (next: " + state.next.name + ")";
                } catch(e){}
                var pl = "Playlist:\n";
                for (var i=0; i<state.play_list.length; i++) {
                    var track = state.play_list[i];
                    pl = pl + "  [" + i + "]: " + track.name + "\n";
                }
                log(pl);
                document.title = s;
            }

            // fired when connection is established and session attached
            connection.onopen = function (session, details) {
                sound = new CommonSound(session, onEmit);
                log("Connected");
            };

            // fired when connection was lost (or could not be established)
            connection.onclose = function (reason, details) {
                log("Connection lost: " + reason);
            }
            connection.open();

            document.getElementById('clear').addEventListener('click', function() {
                document.getElementById('output').value = "";
            });

            document.getElementById('find').addEventListener('click', function() {
                var q = document.getElementById('query').value;
                sound.find(q).then(function(result){
                    log(JSON.stringify(result, null, "    "));
                }).catch(function(e){
                    log("Error in find: " + e.args[0]);
                });
            });

            document.getElementById('play').addEventListener('click', function() {
                var track = document.getElementById('track').value;
                sound.play(track).then(function(result){
                    log(JSON.stringify(result, null, "    "));
                }).catch(function(e){
                    log("Error in play: " + e.args[0]);
                });
            });

            document.getElementById('pause').addEventListener('click', function() {
                sound.pause().then(function(result){
                    log(JSON.stringify(result, null, "    "));
                }).catch(function(e){
                    log("Error in pause: " + e);
                });
            });

            document.getElementById('enqueue').addEventListener('click', function() {
                var track = document.getElementById('track').value;
                sound.enqueue(track).then(function(result){
                    log(JSON.stringify(result, null, "    "));
                }).catch(function(e){
                    log("Error in pause: " + e);
                });
            });

            document.getElementById("fetch").addEventListener('click', function() {
                var album = document.getElementById('album').value;
                sound.cover_image(album).then(function(result) {
                    var image = document.createElement("img");
                    image.src = result.data;
                    var images = document.getElementById('images');
                    if (images.childNodes.length > 0) {
                        images.removeChild(images.childNodes[0]);
                    }
                    images.appendChild(image);
                    result.data = "[removed]";
                    log(JSON.stringify(result, null, "    "));
                }).catch(function(e){
                    log("Error in cover image: " + e.args[0]);
                });
            });

            function log(msg) {
                var ele = document.getElementById('output');
                ele.value = ele.value + msg + "\n";
                ele.scrollTop = ele.scrollHeight;
            };

        </script>
   </body>
</html>

